<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>تفاصيل العقار - عقار</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
        .property-details-container {
            padding-bottom: 60px;
        }
        .property-gallery {
            position: relative;
            height: 250px;
            overflow: hidden;
        }
        .property-gallery img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .property-gallery-nav {
            position: absolute;
            bottom: 15px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        .gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
        }
        .gallery-dot--active {
            background-color: var(--white-color);
        }
        .property-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background-color: var(--white-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 900;
        }
        .property-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-xs);
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.8rem;
        }
        .property-action-btn i {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }
        .property-feature-list {
            display: flex;
            flex-wrap: wrap;
        }
        .property-feature-item {
            flex: 0 0 50%;
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        .property-feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--lighter-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            margin-left: var(--spacing-sm);
            font-size: 1.2rem;
        }
        .property-section {
            margin-bottom: var(--spacing-lg);
        }
        .property-section-title {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header (Transparent) -->
        <header class="app-header" style="background-color: transparent; position: absolute; box-shadow: none; z-index: 10;">
            <div class="app-header-action">
                <a href="index.html" class="back-button" style="color: white; background-color: rgba(0,0,0,0.3); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="app-title" style="color: transparent;">
                <!-- Transparent title for layout -->
            </div>
            <div class="app-header-action">
                <a href="#" class="back-button" id="shareBtn" style="color: white; background-color: rgba(0,0,0,0.3); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-share-alt"></i>
                </a>
            </div>
        </header>


        <!-- App Content -->
        <div class="app-content property-details-container" id="propertyContent">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center py-5" style="min-height: 80vh; display: flex; flex-direction: column; justify-content: center;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-3">جاري تحميل تفاصيل العقار...</p>
            </div>
            
            <!-- Property Details Content (Hidden until loaded) -->
            <div id="propertyDetails" style="display: none;">
                <!-- Property Gallery -->
                <div class="property-gallery">
                    <img src="img/placeholder.jpg" alt="Property" id="propertyMainImage">
                    <div class="property-gallery-nav">
                        <div class="gallery-dot gallery-dot--active"></div>
                        <div class="gallery-dot"></div>
                        <div class="gallery-dot"></div>
                        <div class="gallery-dot"></div>
                    </div>
                </div>

                <!-- Property Details -->
                <div class="container py-3">
                    <div class="property-section">
                        <h1 class="property-card__title" style="font-size: 1.5rem;" id="propertyTitle">جاري التحميل...</h1>
                        <div class="property-card__location mt-2" id="propertyLocation">
                            <i class="fas fa-map-marker-alt property-card__location-icon"></i>
                            جاري التحميل...
                        </div>
                        <div class="property-card__price mt-2" style="font-size: 1.5rem;" id="propertyPrice">جاري التحميل...</div>
                    </div>

                    <!-- Property Features -->
                    <div class="property-section">
                        <h2 class="property-section-title">المميزات</h2>
                        <div class="property-feature-list">
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div>
                                    <div>غرف النوم</div>
                                    <div style="font-weight: 600;" id="propertyBedrooms">-</div>
                                </div>
                            </div>
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-bath"></i>
                                </div>
                                <div>
                                    <div>الحمامات</div>
                                    <div style="font-weight: 600;" id="propertyBathrooms">-</div>
                                </div>
                            </div>
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-ruler-combined"></i>
                                </div>
                                <div>
                                    <div>المساحة</div>
                                    <div style="font-weight: 600;" id="propertyArea">-</div>
                                </div>
                            </div>
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div>
                                    <div>الجراج</div>
                                    <div style="font-weight: 600;">2 سيارة</div>
                                </div>
                            </div>
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div>
                                    <div>سنة البناء</div>
                                    <div style="font-weight: 600;">2020</div>
                                </div>
                            </div>
                            <div class="property-feature-item">
                                <div class="property-feature-icon">
                                    <i class="fas fa-swimming-pool"></i>
                                </div>
                                <div>
                                    <div>حمام سباحة</div>
                                    <div style="font-weight: 600;">نعم</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Property Description -->
                    <div class="property-section">
                        <h2 class="property-section-title">الوصف</h2>
                        <div id="propertyDescriptionContainer">
                            <p id="propertyDescription">جاري التحميل...</p>
                        </div>
                    </div>
                    
                    <!-- Location section removed -->
                    
                    <!-- Owner section removed -->
                </div>
            </div>
            
            <!-- Error Container -->
            <div id="errorContainer" style="display: none;" class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--danger-color);"></i>
                <p class="mt-3" id="errorMessage">حدث خطأ في تحميل العقار</p>
                <a href="index.html" class="btn btn--primary mt-3">العودة إلى الرئيسية</a>
            </div>
        </div>

        <!-- Property Actions Bar -->
        <div class="property-actions" id="propertyActions" style="display: none;">
            <a href="#" class="property-action-btn" id="favoriteBtn" data-property-id="">
                <i class="far fa-heart"></i>
                <span>المفضلة</span>
            </a>
            <a href="#message" class="property-action-btn">
                <i class="far fa-comment"></i>
                <span>رسالة</span>
            </a>
            <a href="tel:+123456789" class="property-action-btn">
                <i class="fas fa-phone-alt"></i>
                <span>اتصال</span>
            </a>
            <!-- Booking button removed -->
        </div>
    </div>

    <script type="module">
        import { initializeJsonService } from './js/json-service.js';
        import { getCurrentUser } from './js/auth-service.js';
        import { getProperty } from './js/property-service.js';
        import { toggleFavorite } from './js/auth-service.js';
        import { isFavorite } from './js/favorites-service.js';
        import { showToast, showLoginModal } from './js/app.js';
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const tabBar = document.querySelector('.tab-bar');
                if (tabBar) {
                    tabBar.style.display = 'none';
                }
                
                await initializeJsonService();
                
                const user = await getCurrentUser();
                
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('id');
                
                if (!propertyId) {
                    showError('معرّف العقار غير موجود');
                    return;
                }
                
                await loadPropertyData(propertyId, user);
                
                initializeInteractions(propertyId, user);
                
            } catch (error) {
                console.error("Error initializing property details page:", error);
                showError('حدث خطأ في تحميل تفاصيل العقار');
            }
        });
        
        async function loadPropertyData(propertyId, user) {
            try {
                const property = await getProperty(propertyId);
                
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('propertyDetails').style.display = 'block';
                document.getElementById('propertyActions').style.display = 'flex';
                
                document.title = `${property.title} - عقار`;
                
                updatePropertyUI(property);
                
                if (user) {
                    const isFav = await isFavorite(user.id, propertyId);
                    updateFavoriteButtonState(isFav);
                }
            } catch (error) {
                console.error("Error loading property:", error);
                showError('العقار غير موجود أو حدث خطأ في التحميل');
            }
        }
        
        function updatePropertyUI(property) {
            document.getElementById('propertyTitle').textContent = property.title;
            document.getElementById('propertyPrice').textContent = property.priceFormatted;
            
            const locationElement = document.getElementById('propertyLocation');
            const locationIcon = locationElement.querySelector('i');
            locationElement.innerHTML = '';
            locationElement.appendChild(locationIcon);
            locationElement.appendChild(document.createTextNode(' ' + property.location));
            
            document.getElementById('propertyBedrooms').textContent = `${property.features.bedrooms} غرف`;
            document.getElementById('propertyBathrooms').textContent = `${property.features.bathrooms} حمامات`;
            document.getElementById('propertyArea').textContent = `${property.features.area} قدم²`;
            
            const descriptionContainer = document.getElementById('propertyDescriptionContainer');
            descriptionContainer.innerHTML = '';
            
            const paragraphs = property.description.split('\n\n');
            paragraphs.forEach((paragraph, index) => {
                const p = document.createElement('p');
                p.textContent = paragraph;
                if (index > 0) p.className = 'mt-2';
                descriptionContainer.appendChild(p);
            });
            
            document.getElementById('propertyMainImage').src = property.imageUrl;
            
            document.getElementById('favoriteBtn').dataset.propertyId = property.id;
        }
        
        function updateFavoriteButtonState(isFavorited) {
            const favoriteBtn = document.getElementById('favoriteBtn');
            const heartIcon = favoriteBtn.querySelector('i');
            
            if (isFavorited) {
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
                heartIcon.style.color = '#ef4444';
            } else {
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
                heartIcon.style.color = '';
            }
        }
        
        function initializeInteractions(propertyId, user) {
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (!user) {
                        showLoginModal('يجب تسجيل الدخول أولاً لإضافة العقار إلى المفضلة');
                        return;
                    }
                    
                    try {
                        const isAdded = await toggleFavorite(user.id, propertyId);
                        updateFavoriteButtonState(isAdded);
                        
                        if (isAdded) {
                            showToast('تمت إضافة العقار إلى المفضلة', 'success');
                        } else {
                            showToast('تمت إزالة العقار من المفضلة', 'info');
                        }
                    } catch (error) {
                        console.error("Error toggling favorite:", error);
                        showToast('حدث خطأ، يرجى المحاولة مرة أخرى', 'error');
                    }
                });
            }
            
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    shareProperty(propertyId);
                });
            }
        }
        
        function shareProperty(propertyId) {
            const shareUrl = `${window.location.origin}/property-details.html?id=${propertyId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: shareUrl
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareUrl)
                    .then(() => {
                        showToast('تم نسخ الرابط إلى الحافظة', 'success');
                    })
                    .catch(() => {
                        const textarea = document.createElement('textarea');
                        textarea.value = shareUrl;
                        textarea.style.position = 'fixed';
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        
                        try {
                            document.execCommand('copy');
                            showToast('تم نسخ الرابط إلى الحافظة', 'success');
                        } catch (err) {
                            showToast('فشل نسخ الرابط', 'error');
                        }
                        
                        document.body.removeChild(textarea);
                    });
            }
        }
        
        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('propertyDetails').style.display = 'none';
            
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
        }
    </script>
</body>
</html>